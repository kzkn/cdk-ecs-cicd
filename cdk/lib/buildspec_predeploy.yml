---
version: '0.2'
phases:
  pre_build:
    commands:
      - $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
  build:
    commands:
      - DATABASE_URL=`echo $DATABASE_CREDENTIALS | jq '"postgres://" + .username + ":" + .password + "@" + .host + ":" + (.port|tostring) + "/" + .dbname'`
      - docker run --rm $APP_REPOSITORY_URI:$IMAGE_TAG bin/rails app:release -e "DATABASE_URL=$DATABASE_URL"
